// Step Event for obj_camera

// Ensure the player instance exists
if (instance_exists(global.player_instance)) {
    // Calculate target camera position to center on the player
    var target_x = global.player_instance.x - (camera_get_view_width(global.camera) / 2);
    var target_y = global.player_instance.y - (camera_get_view_height(global.camera) / 2);

    // Clamp the camera position to ensure it stays within the room boundaries
    target_x = clamp(target_x, 0, room_width - camera_get_view_width(global.camera));
    target_y = clamp(target_y, 0, room_height - camera_get_view_height(global.camera));

    // Smoothly move the camera towards the target position
    var current_x = camera_get_view_x(global.camera);
    var current_y = camera_get_view_y(global.camera);
    var smooth_x = lerp(current_x, target_x, 0.1);
    var smooth_y = lerp(current_y, target_y, 0.1);

    // Set the new camera position
    camera_set_view_pos(global.camera, smooth_x, smooth_y);

    // Debug messages to verify updates
    show_debug_message("Player position: (" + string(global.player_instance.x) + ", " + string(global.player_instance.y) + ")");
    show_debug_message("Camera position: (" + string(camera_get_view_x(global.camera)) + ", " + string(camera_get_view_y(global.camera)) + ")");
} else {
    show_debug_message("Error: global.player_instance does not exist.");
}

if (keyboard_check_pressed(ord("E"))) {
    // Check for interaction with the ice truck
    var ice_truck = noone;
    with (obj_icetruck) {
        if (point_distance(x, y, global.player_instance.x, global.player_instance.y) < 48) {
            ice_truck = id; // Assign the ID of the nearby ice truck
            break; // Exit the loop once a valid truck is found
        }
    }

    if (ice_truck != noone && global.current_skin == "player") {
        // Switch to ice truck player
        var player_x = global.player_instance.x;
        var player_y = global.player_instance.y;

        instance_destroy(global.player_instance); // Destroy the current player instance
        instance_destroy(ice_truck); // Remove the ice truck from the room

        global.player_instance = instance_create_layer(player_x, player_y, "Instances", obj_player_icetruck);
        global.current_skin = "icetruck"; // Update the current skin
    } else if (global.current_skin == "icetruck") {
        // Switch back to player
        var player_x = global.player_instance.x;
        var player_y = global.player_instance.y;

        instance_destroy(global.player_instance); // Destroy the current player instance
        instance_create_layer(player_x, player_y, "Instances", obj_icetruck); // Add the ice truck back to the room
        global.player_instance = instance_create_layer(player_x, player_y, "Instances", obj_player);
        global.current_skin = "player"; // Update the current skin
    }
}

// Ensure the viewport follows the current player instance
if (instance_exists(global.player_instance)) {
    var view_x = clamp(global.player_instance.x - (view_wview[0] / 2), 0, room_width - view_wview[0]);
    var view_y = clamp(global.player_instance.y - (view_hview[0] / 2), 0, room_height - view_hview[0]);
    view_xview[0] = view_x;
    view_yview[0] = view_y;
}